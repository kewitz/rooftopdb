// Generated by CoffeeScript 1.6.2
(function() {
  var Q, cmd, fs, isSass, path, spawn,
    __slice = [].slice;

  spawn = require('child_process').spawn;

  path = require('path');

  fs = require('fs');

  Q = require('kew');

  cmd = function() {
    var args, cmd, promise, ps, stderr, stdout;

    cmd = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
    promise = Q.defer();
    ps = spawn(cmd, args);
    stdout = [];
    stderr = [];
    ps.stdout.on('data', function(chunk) {
      return stdout.push(chunk);
    });
    ps.stderr.on('data', function(chunk) {
      return stderr.push(chunk);
    });
    ps.on('exit', function(code) {
      if (code === 0) {
        return promise.resolve(stdout.join(''));
      } else {
        return promise.reject(new Error(stderr.join('')));
      }
    });
    return promise;
  };

  isSass = /\.(sass|scss)$/;

  exports.serve = function(options) {
    var contentType, dirname, filename, render, rendered;

    if (options.toString() === '[object Object]') {
      filename = options.filename;
      contentType = options.contentType || 'text/css';
    } else {
      filename = options;
      contentType = 'text/css';
    }
    dirname = path.dirname(filename);
    render = function() {
      return cmd('sass', '--compass', filename);
    };
    rendered = render();
    fs.watch(dirname, {
      persistent: false
    }, function(ev, filename) {
      if (isSass.test(filename)) {
        return rendered = render();
      }
    });
    return function(req, res, next) {
      return rendered.then(function(result) {
        res.setHeader('Content-type', contentType);
        return res.end(result);
      }).fail(next);
    };
  };

}).call(this);

/*
//@ sourceMappingURL=index.map
*/
